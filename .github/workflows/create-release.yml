---

name: Create Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: Type of release
        required: true
        default: patch
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  test:
    name: Run tests
    uses: ./.github/workflows/test.yml

  read-version:
    name: Read current version and calculate new version
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.current_version.outputs.version }}
      new_version: ${{ steps.new_version.outputs.version }}
    steps:
      -
        name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
      -
        name: Set up Ruby
        uses: ruby/setup-ruby@v1.267.0
        with:
          ruby-version: "3.4"
          bundler-cache: true
      -
        name: Read current version
        id: current_version
        run: |
          current_version=$(ruby -e "require './lib/semian/version'; puts Semian::VERSION")
          echo "version=$current_version" >> $GITHUB_OUTPUT
          echo "Current version: $current_version"
      -
        name: Calculate new version
        id: new_version
        run: |
          chmod +x .github/scripts/calculate_version.sh
          .github/scripts/calculate_version.sh \
            "${{ steps.current_version.outputs.version }}" \
            "${{ github.event.inputs.release_type }}"

  create-pr:
    name: Create pull request for version bump
    runs-on: ubuntu-latest
    needs: [test, read-version]
    permissions:
      contents: write
      pull-requests: write
    steps:
      -
        name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
        with:
          ref: main
          fetch-depth: 0
          fetch-tags: true
      -
        name: Set up Ruby
        uses: ruby/setup-ruby@v1.267.0
        with:
          ruby-version: "3.4"
          bundler-cache: true
      -
        name: Create changes
        env:
          BUNDLE_FROZEN: false
        run: |
          new_version="${{ needs.read-version.outputs.new_version }}"

          # Create version file changes
          sed -i "s/VERSION = \".*\"/VERSION = \"$new_version\"/" lib/semian/version.rb

          # Create Gemfile.lock changes
          bundle install

          # Create CHANGELOG changes
          chmod +x .github/scripts/update_changelog.sh
          .github/scripts/update_changelog.sh \
            "${{ needs.read-version.outputs.new_version }}" \
            "${{ needs.read-version.outputs.current_version }}"
      -
        name: Create and push branch
        run: |
          new_version="${{ needs.read-version.outputs.new_version }}"
          branch_name="release/v$new_version"

          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git checkout -b "$branch_name"
          git push origin "$branch_name"
      -
        name: Create signed commit
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          github-token: ${{ secrets.SHOPIFY_GH_ACCESS_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');
            const message = 'Bump version to ${{ needs.read-version.outputs.new_version }}';
            const directory = '.';

            execSync(`git add ${directory}`);

            const gitCmd = `git -c core.quotePath=false status ${directory} --porcelain=v1`;
            const status = execSync(gitCmd).toString();
            const fileChanges = status
              .split('\n')
              .filter(line => line)
              .map(line => {
                const [_, status, path] = line.match(/^(.). (.*)/);

                if (status === 'R') {
                  const [oldPath, newPath] = path.split(' -> ');
                  return [
                    { path: newPath, contents: fs.readFileSync(newPath).toString('base64') },
                    { path: oldPath, contents: null }
                  ];
                }

                return [{
                  path,
                  contents: status !== 'D' ? fs.readFileSync(path).toString('base64') : null
                }];
              })
              .flat();

            const additions = fileChanges.filter(f => f.contents !== null);
            const deletions = fileChanges
              .filter(f => f.contents === null)
              .map(f => ({ path: f.path }));

            console.log('Committing changes:');
            additions.forEach(file => console.log(`  + ${file.path}`));
            deletions.forEach(file => console.log(`  - ${file.path}`));

            const branch = 'release/v${{ needs.read-version.outputs.new_version }}';
            console.log(`Target branch: ${branch}`);

            const query = `
              mutation CreateCommit($input: CreateCommitOnBranchInput!) {
                createCommitOnBranch(input: $input) {
                  commit {
                    url
                  }
                }
              }
            `;

            const result = await github.graphql(query, {
              input: {
                branch: {
                  repositoryNameWithOwner: `${context.repo.owner}/${context.repo.repo}`,
                  branchName: branch
                },
                message: { headline: message },
                fileChanges: { additions, deletions },
                expectedHeadOid: context.sha
              }
            });

            console.log(`Commit created: ${result.createCommitOnBranch.commit.url}`);
      -
        name: Create pull request
        env:
          GH_TOKEN: ${{ secrets.SHOPIFY_GH_ACCESS_TOKEN }}
        run: |
          new_version="${{ needs.read-version.outputs.new_version }}"
          branch_name="release/v$new_version"

          gh pr create \
            --title "Release v$new_version" \
            --body "Automated version bump to $new_version

          This PR includes:
          - Updated version in \`lib/semian/version.rb\`
          - Updated \`Gemfile.lock\`
          - Updated \`CHANGELOG.md\`

          **Release type:** ${{ github.event.inputs.release_type }}
          **Triggered by:** @${{ github.actor }}

          After merging this PR, the **Publish Release** workflow will automatically \
          build the gem and publish it to GitHub releases." \
            --base main \
            --head "$branch_name"
