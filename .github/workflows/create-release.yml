---

name: Create Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: Type of release
        required: true
        default: patch
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  test:
    name: Run tests
    uses: ./.github/workflows/test.yml

  read-version:
    name: Read current version and calculate new version
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.current_version.outputs.version }}
      new_version: ${{ steps.new_version.outputs.version }}
    steps:
      -
        name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
      -
        name: Set up Ruby
        uses: ruby/setup-ruby@v1.267.0
        with:
          ruby-version: "3.4"
          bundler-cache: true
      -
        name: Read current version
        id: current_version
        run: |
          current_version=$(ruby -e "require './lib/semian/version'; puts Semian::VERSION")
          echo "version=$current_version" >> $GITHUB_OUTPUT
          echo "Current version: $current_version"
      -
        name: Calculate new version
        id: new_version
        run: |
          chmod +x .github/scripts/calculate_version.sh
          .github/scripts/calculate_version.sh \
            "${{ steps.current_version.outputs.version }}" \
            "${{ github.event.inputs.release_type }}"

  create-pr:
    name: Create pull request for version bump
    runs-on: ubuntu-latest
    needs: [test, read-version]
    permissions:
      contents: write
      pull-requests: write
    steps:
      -
        name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
        with:
          ref: main
          fetch-depth: 0
          fetch-tags: true
      -
        name: Set up Ruby
        uses: ruby/setup-ruby@v1.267.0
        with:
          ruby-version: "3.4"
          bundler-cache: true
      -
        name: Create changes
        env:
          BUNDLE_FROZEN: false
        run: |
          new_version="${{ needs.read-version.outputs.new_version }}"

          # Create version file changes
          sed -i "s/VERSION = \".*\"/VERSION = \"$new_version\"/" lib/semian/version.rb

          # Create Gemfile.lock changes
          bundle install

          # Create CHANGELOG changes
          chmod +x .github/scripts/update_changelog.sh
          .github/scripts/update_changelog.sh \
            "${{ needs.read-version.outputs.new_version }}" \
            "${{ needs.read-version.outputs.current_version }}"
      -
        name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.SHOPIFY_GH_ACCESS_TOKEN }}
          branch: release/v${{ needs.read-version.outputs.new_version }}
          base: main
          title: Release v${{ needs.read-version.outputs.new_version }}
          body: |
            Automated version bump to ${{ needs.read-version.outputs.new_version }}

            This PR includes:
            - Updated version in `lib/semian/version.rb`
            - Updated `Gemfile.lock`
            - Updated `CHANGELOG.md`

            **Release type:** ${{ github.event.inputs.release_type }}
            **Triggered by:** @${{ github.actor }}

            After merging this PR, the **Publish Release** workflow will automatically
            build the gem and publish it to GitHub releases.
          commit-message: Bump version to ${{ needs.read-version.outputs.new_version }}
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          sign-commits: true
          add-paths: |
            lib/semian/version.rb
            Gemfile.lock
            CHANGELOG.md
