---

name: Publish Release

on:
  push:
    branches:
      - main
    paths:
      - lib/semian/version.rb

jobs:
  check-version-bump:
    name: Check if this is a version bump
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
      version: ${{ steps.version.outputs.version }}
    steps:
      -
        name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
        with:
          fetch-depth: 2
      -
        name: Check if commit is version bump
        id: check
        run: |
          # Check if the commit message indicates a version bump
          commit_msg=$(git log -1 --pretty=%s)
          if [[ "$commit_msg" =~ ^"Bump version to" ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "âœ… Detected version bump commit: $commit_msg"
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "âŒ Not a version bump commit: $commit_msg"
          fi
      -
        name: Set up Ruby
        if: steps.check.outputs.is_release == 'true'
        uses: ruby/setup-ruby@v1.280.0
        with:
          ruby-version: "3.4"
          bundler-cache: true
      -
        name: Read version
        if: steps.check.outputs.is_release == 'true'
        id: version
        run: |
          version=$(ruby -e "require './lib/semian/version'; puts Semian::VERSION")
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Current version: $version"

  build-and-release:
    name: Build gem and create GitHub release
    runs-on: ubuntu-latest
    needs: [check-version-bump]
    if: needs.check-version-bump.outputs.is_release == 'true'
    permissions:
      contents: write
    steps:
      -
        name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
      -
        name: Set up Ruby
        uses: ruby/setup-ruby@v1.280.0
        with:
          ruby-version: "3.4"
          bundler-cache: true
      -
        name: Create and push tag
        env:
          VERSION: ${{ needs.check-version-bump.outputs.version }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag "v$VERSION"
          git push origin "v$VERSION"
          echo "âœ… Created and pushed tag v$VERSION"
      -
        name: Build C extension
        run: bundle exec rake build
      -
        name: Build gem
        run: |
          gem build semian.gemspec
      -
        name: Generate SHA512 checksum
        run: |
          for gem in semian-*.gem; do
            sha512sum "$gem" > "${gem}.sha512"
          done
      -
        name: Draft GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.check-version-bump.outputs.version }}
        run: |
          tag="v$VERSION"
          gh release create "$tag" \
            --title "$tag" \
            --generate-notes \
            --draft \
            semian-*.gem \
            semian-*.gem.sha512
      -
        name: Filter release PR commits
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.check-version-bump.outputs.version }}
        run: |
          tag="v$VERSION"
          gh release view "$tag" --json body -q '.body' > temp_notes.md

          # Filter out dependabot commits and the release PR itself
          grep -v -i "bump.*by.*dependabot" temp_notes.md | \
          grep -v -i "release v.*by.*@github-actions" > filtered_notes.md || true

          echo "Filtered release notes:"
          cat filtered_notes.md
      -
        name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.check-version-bump.outputs.version }}
        run: |
          tag="v$VERSION"
          gh release edit "$tag" \
            --notes-file filtered_notes.md \
            --draft=false
          echo "ðŸš€ Published release $tag"
