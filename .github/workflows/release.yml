---

name: Release

on:
  push:
    tags:
      - v*
      - test-*

jobs:
  test:
    name: Run tests
    uses: ./.github/workflows/test.yml

  verify-version:
    name: Verify Gem version matches tag
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
      -
        name: Check version
        run: |
          TAG=${GITHUB_REF#refs/tags/}

          # Skip version check for test tags
          if [[ "$TAG" == test-* ]]; then
            echo "Test tag detected, skipping version check"
            exit 0
          fi

          TAG_VERSION=${TAG#v}
          GEM_VERSION=$(grep -E "VERSION = \"[0-9]+\.[0-9]+\.[0-9]+\"" \
            lib/semian/version.rb | grep -oE "[0-9]+\.[0-9]+\.[0-9]+")
          echo "Tag version: $TAG_VERSION"
          echo "Gem version: $GEM_VERSION"
          if [ "$TAG_VERSION" != "$GEM_VERSION" ]; then
            echo "Error: Tag version ($TAG_VERSION) does not match gem version ($GEM_VERSION)"
            exit 1
          fi
          echo "Version check passed!"

  build-and-release:
    name: Build gem and create GitHub release
    runs-on: ubuntu-latest
    needs: [test, verify-version]
    permissions:
      contents: write
    steps:
      -
        name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
      -
        name: Set up Ruby
        uses: ruby/setup-ruby@v1.263.0
        with:
          ruby-version: "3.4"
          bundler-cache: true
      -
        name: Build C extension
        run: bundle exec rake build
      -
        name: Build gem
        run: |
          gem build semian.gemspec
      -
        name: Generate SHA512 checksum
        run: |
          for gem in semian-*.gem; do
            sha512sum "$gem" > "${gem}.sha512"
          done
      -
        name: Extract version from tag
        id: tag
        run: |
          tag=${GITHUB_REF#refs/tags/}
          echo "tag=$tag" >> $GITHUB_OUTPUT
      -
        name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          tag="${{ steps.tag.outputs.tag }}"
          gh release create "$tag" \
            --title "$tag" \
            --generate-notes \
            semian-*.gem \
            semian-*.gem.sha512

