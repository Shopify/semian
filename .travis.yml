dist: xenial
language: minimal

git:
  depth: 1

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/1.24.0/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

services:
  - docker

gemfile:
  - Gemfile
  - gemfiles/hiredis-0-6.gemfile
  - gemfiles/mysql2-0-4-10.gemfile
  - gemfiles/mysql2-0-5-0.gemfile

env:
  - SEMIAN_CIRCUIT_BREAKER_IMPL=worker
  - SEMIAN_CIRCUIT_BREAKER_IMPL=host

matrix:
  exclude:
  - gemfile: gemfiles/hiredis-0-6.gemfile
    env: SEMIAN_CIRCUIT_BREAKER_IMPL=host
  - gemfile: gemfiles/mysql2-0-4-10.gemfile
    env: SEMIAN_CIRCUIT_BREAKER_IMPL=host
  - gemfile: gemfiles/mysql2-0-5-0.gemfile
    env: SEMIAN_CIRCUIT_BREAKER_IMPL=host

script:
  - |
    docker build \
    --build-arg BUNDLE_GEMFILE="$BUNDLE_GEMFILE" \
    --build-arg SEMIAN_CIRCUIT_BREAKER_IMPL="$SEMIAN_CIRCUIT_BREAKER_IMPL" \
    -t shopify/semian-ci:latest \
    -f dockerfiles/semian-ci .
  - travis_retry docker-compose -f docker-compose.ci.yml up --force-recreate --exit-code-from semian

notifications:
  email: false
