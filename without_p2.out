============================================================
Adaptive Circuit Breaker with Net::HTTP Example
============================================================

Configuring Semian with adaptive circuit breaker...
Configuration complete!

Phase 1: Normal operation (successful requests)
----------------------------------------
Request 1: Success (HTTP 200)
Request 2: Success (HTTP 200)
Request 3: Success (HTTP 200)
Request 4: Success (HTTP 200)
Request 5: Success (HTTP 200)
Request 6: Success (HTTP 200)
Request 7: Success (HTTP 200)
Request 8: Success (HTTP 200)
Request 9: Success (HTTP 200)
Request 10: Success (HTTP 200)
Request 11: Success (HTTP 200)
Request 12: Success (HTTP 200)
Request 13: Success (HTTP 200)
Request 14: Success (HTTP 200)
Request 15: Success (HTTP 200)
Request 16: Success (HTTP 200)
Request 17: Success (HTTP 200)
Request 18: Success (HTTP 200)
Request 19: Success (HTTP 200)
Request 20: Success (HTTP 200)
Request 21: Success (HTTP 200)
Request 22: Success (HTTP 200)
Request 23: Success (HTTP 200)
Request 24: Success (HTTP 200)
Request 25: Success (HTTP 200)
Request 26: Success (HTTP 200)
Request 27: Success (HTTP 200)
Request 28: Success (HTTP 200)
Request 29: Success (HTTP 200)
Request 30: Success (HTTP 200)
Request 31: Success (HTTP 200)
Request 32: Success (HTTP 200)
Request 33: Success (HTTP 200)
Request 34: Success (HTTP 200)
Request 35: Success (HTTP 200)
Request 36: Success (HTTP 200)
Request 37: Success (HTTP 200)
Request 38: Success (HTTP 200)
Request 39: Success (HTTP 200)
Request 40: Success (HTTP 200)
Request 41: Success (HTTP 200)
Request 42: Success (HTTP 200)
Request 43: Success (HTTP 200)
Request 44: Error - RuntimeError: can't modify string; temporarily locked
<internal:io>:63:in 'IO#read_nonblock'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/protocol.rb:218:in 'Net::BufferedIO#rbuf_fill'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/protocol.rb:199:in 'Net::BufferedIO#readuntil'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/protocol.rb:209:in 'Net::BufferedIO#readline'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/http/response.rb:158:in 'Net::HTTPResponse.read_status_line'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/http/response.rb:147:in 'Net::HTTPResponse.read_new'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/http.rb:2414:in 'block in Net::HTTP#transport_request'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/http.rb:2405:in 'Kernel#catch'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/http.rb:2405:in 'Net::HTTP#transport_request'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/net_http.rb:109:in 'block (2 levels) in Semian::NetHTTP#transport_request'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/adapter.rb:84:in 'Semian::Adapter#mark_resource_as_acquired'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/adapter.rb:44:in 'block in Semian::Adapter#acquire_semian_resource'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/protected_resource.rb:36:in 'block (2 levels) in Semian::ProtectedResource#acquire'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/protected_resource.rb:65:in 'block in Semian::ProtectedResource#acquire_bulkhead'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/resource.rb:46:in 'Semian::Resource#acquire'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/protected_resource.rb:64:in 'Semian::ProtectedResource#acquire_bulkhead'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/protected_resource.rb:34:in 'block in Semian::ProtectedResource#acquire'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/protected_resource.rb:52:in 'block in Semian::ProtectedResource#acquire_circuit_breaker'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/adaptive_circuit_breaker.rb:61:in 'Semian::AdaptiveCircuitBreaker#acquire'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/protected_resource.rb:51:in 'Semian::ProtectedResource#acquire_circuit_breaker'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/protected_resource.rb:33:in 'Semian::ProtectedResource#acquire'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/adapter.rb:43:in 'Semian::Adapter#acquire_semian_resource'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/net_http.rb:108:in 'block in Semian::NetHTTP#transport_request'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/net_http.rb:166:in 'Semian::NetHTTP#with_cleared_dynamic_options'
/Users/kristofergaudel/src/github.com/Shopify/semian/lib/semian/net_http.rb:105:in 'Semian::NetHTTP#transport_request'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/http.rb:2378:in 'Net::HTTP#request'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/http.rb:2371:in 'block in Net::HTTP#request'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/http.rb:1626:in 'Net::HTTP#start'
/Users/kristofergaudel/.dev/rubies/3.4.3/lib/ruby/3.4.0/net/http.rb:2369:in 'Net::HTTP#request'
examples/adaptive_with_net_http.rb:57:in 'Object#make_request'
examples/adaptive_with_net_http.rb:69:in 'block in <main>'
<internal:numeric>:257:in 'Integer#times'
examples/adaptive_with_net_http.rb:67:in '<main>'
Request 45: Success (HTTP 200)
Request 46: Success (HTTP 200)
Request 47: Success (HTTP 200)
Request 48: Success (HTTP 200)
Request 49: Success (HTTP 200)
Request 50: Success (HTTP 200)
Request 51: Success (HTTP 200)
Request 52: Success (HTTP 200)
Request 53: Success (HTTP 200)
Request 54: Success (HTTP 200)
Request 55: Success (HTTP 200)
Request 56: Success (HTTP 200)
Request 57: Success (HTTP 200)
Request 58: Success (HTTP 200)
Request 59: Success (HTTP 200)
Request 60: Success (HTTP 200)

Phase 2: Simulating errors (requesting error status codes)
----------------------------------------
Request 1: Got HTTP 503
Request 2: Got HTTP 503
Request 3: Got HTTP 503
Request 4: Got HTTP 503
Request 5: Got HTTP 503
Request 6: Got HTTP 503
Request 7: Got HTTP 503
Request 8: Got HTTP 503
Request 9: Got HTTP 503
Request 10: Got HTTP 503
Request 11: Got HTTP 503
Request 12: Got HTTP 503
Request 13: Got HTTP 503
Request 14: Got HTTP 503
Request 15: Got HTTP 503
Request 16: Got HTTP 503
Request 17: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 18: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 19: Got HTTP 503
Request 20: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 21: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 22: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 23: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 24: Got HTTP 503
Request 25: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 26: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 27: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 28: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 29: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 30: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 31: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 32: Got HTTP 503
Request 33: Got HTTP 503
Request 34: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 35: Got HTTP 503
Request 36: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.5138099152046784) caused by SERVICE UNAVAILABLE
Request 37: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.05557630119590623) caused by SERVICE UNAVAILABLE
Request 38: Got HTTP 503
Request 39: Got HTTP 503
Request 40: Got HTTP 503
Request 41: Got HTTP 503
Request 42: Got HTTP 503
Request 43: Got HTTP 503
Request 44: Got HTTP 503
Request 45: Got HTTP 503
Request 46: Got HTTP 503
Request 47: Got HTTP 503
Request 48: Got HTTP 503
Request 49: Got HTTP 503
Request 50: Got HTTP 503
Request 51: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.05557630119590623) caused by SERVICE UNAVAILABLE
Request 52: Got HTTP 503
Request 53: Got HTTP 503
Request 54: Got HTTP 503
Request 55: Got HTTP 503
Request 56: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 57: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 58: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 59: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 60: Got HTTP 503

Phase 3: Recovery (back to successful requests)
----------------------------------------
Request 1: Success (HTTP 200)
Request 2: Success (HTTP 200)
Request 3: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 4: Success (HTTP 200)
Request 5: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 6: Success (HTTP 200)
Request 7: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 8: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 9: Success (HTTP 200)
Request 10: Success (HTTP 200)
Request 11: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 12: Success (HTTP 200)
Request 13: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 14: Error - Net::CircuitOpenError: [nethttp_localhost_80] Rejected by adaptive circuit breaker (rejection_rate: 0.30460515561498347) caused by SERVICE UNAVAILABLE
Request 15: Success (HTTP 200)
Request 16: Success (HTTP 200)
Request 17: Success (HTTP 200)
Request 18: Success (HTTP 200)
Request 19: Success (HTTP 200)
Request 20: Success (HTTP 200)
Request 21: Success (HTTP 200)
Request 22: Success (HTTP 200)
Request 23: Success (HTTP 200)
Request 24: Success (HTTP 200)
Request 25: Success (HTTP 200)
Request 26: Success (HTTP 200)
Request 27: Success (HTTP 200)
Request 28: Success (HTTP 200)
Request 29: Success (HTTP 200)
Request 30: Success (HTTP 200)
Request 31: Success (HTTP 200)
Request 32: Success (HTTP 200)
Request 33: Success (HTTP 200)
Request 34: Success (HTTP 200)
Request 35: Success (HTTP 200)
Request 36: Success (HTTP 200)
Request 37: Success (HTTP 200)
Request 38: Success (HTTP 200)
Request 39: Success (HTTP 200)
Request 40: Success (HTTP 200)
Request 41: Success (HTTP 200)
Request 42: Success (HTTP 200)
Request 43: Success (HTTP 200)
Request 44: Success (HTTP 200)
Request 45: Success (HTTP 200)
Request 46: Success (HTTP 200)
Request 47: Success (HTTP 200)
Request 48: Success (HTTP 200)
Request 49: Success (HTTP 200)
Request 50: Success (HTTP 200)
Request 51: Success (HTTP 200)
Request 52: Success (HTTP 200)
Request 53: Success (HTTP 200)
Request 54: Success (HTTP 200)
Request 55: Success (HTTP 200)
Request 56: Success (HTTP 200)
Request 57: Success (HTTP 200)
Request 58: Success (HTTP 200)
Request 59: Success (HTTP 200)
Request 60: Success (HTTP 200)

============================================================
Example complete!
============================================================

Key Points:
- The adaptive circuit breaker works seamlessly with existing adapters
- It monitors request success/failure rates automatically
- Background health checks help detect recovery
- The rejection rate adjusts dynamically based on service health
